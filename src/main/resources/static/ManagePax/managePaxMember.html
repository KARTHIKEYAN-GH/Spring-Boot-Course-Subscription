<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PaxMember Management</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #search {
      width: 250px;
      text-align: center;
      color: black;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-primary" href="managePaxUsers.html">ManagePax</a>
      <h2>All PaxMembers</h2>
      <div class="d-flex align-items-center">
        <input type="text" id="search" name="search" placeholder="Search by name, phone, or email" class="form-control mr-2">
      </div>
    </div>

    <table id="paxMemberTable" class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>PhoneNumber</th>
          <th>Email</th>
          <th>Relation</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="paxMemberTableBody">
      </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <button id="prevPage" class="btn btn-success">Previous</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextPage" class="btn btn-success">Next</button>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const uuid = urlParams.get('uuid');

    let currentPage = 0;
    const pageSize = 2;
    let paxMembers = []; // Store fetched PaxMember data
    let totalPages = 1; // Total number of pages

    // Fetch and display PaxMembers dynamically
    function loadPaxMembers(page = 0, query = '') {
      const apiUrl = query 
        ? `/api/admin/pax/searchMember/${uuid}?query=${query}` 
        : `/api/admin/pax/getMemberByHeadId/${uuid}?page=${page}&size=${pageSize}`;

      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          if (query) {
            paxMembers = data;
            totalPages = 1;
          } else {
            paxMembers = data.content;
            totalPages = data.totalPages;
          }
          displayPaxMembers(paxMembers);
          updatePagination();
        })
        .catch(error => {
          console.error('Error fetching PaxMembers:', error);
          alert('Failed to load PaxMembers');
        });
    }

    // Display PaxMembers in the table
    function displayPaxMembers(paxMembers) {
      const paxMemberTableBody = document.getElementById('paxMemberTableBody');
      paxMemberTableBody.innerHTML = '';

      paxMembers.forEach(member => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${member.name}</td>
          <td>${(member.countryCode || '') + (member.phoneNumber || '')}</td>
          <td>${member.email}</td>
          <td>${member.relation}</td>
          <td>
            <a href="updateMember.html?uuid=${member.uuid}" class="btn btn-primary btn-sm">Edit</a>
            <button class="btn btn-danger btn-sm" onclick="deletePaxMember('${member.uuid}')">Delete</button>
          </td>
        `;
        paxMemberTableBody.appendChild(row);
      });
    }

    // Function to delete PaxMember
    function deletePaxMember(uuid) {
      if (confirm("Are you sure you want to delete this PaxMember?")) {
        fetch(`/api/admin/pax/deleteMember/${uuid}`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              loadPaxMembers(currentPage); // Reload PaxMembers after deletion
            } else {
              alert("Failed to delete the PaxMember.");
            }
          });
      }
    }

    // Update pagination controls
    function updatePagination() {
      document.getElementById('pageInfo').innerText = `Page ${currentPage + 1} of ${totalPages}`;
      document.getElementById('prevPage').disabled = currentPage <= 0;
      document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;
    }

    // Event listeners for pagination buttons
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        loadPaxMembers(currentPage);
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      if (currentPage < totalPages - 1) {
        currentPage++;
        loadPaxMembers(currentPage);
      }
    });

    // Event listener for search input
    document.getElementById('search').addEventListener('input', function (e) {
      const searchText = e.target.value.trim().toLowerCase();
      if (searchText) {
        loadPaxMembers(0, searchText);  // Reset to the first page for search results
      } else {
        loadPaxMembers(currentPage);    // Show current page when search is cleared
      }
    });

    // Initialize by loading all PaxMembers for the first page
    loadPaxMembers();
  </script>
</body>
</html>
